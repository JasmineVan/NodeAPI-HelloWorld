'use strict';

var accepts = require('accepts'),
	cookie = require('cookie'),
	util = require('mini-util'),
	parse = require('./util/parse'),
	Message = require('./message'),
	Response = require('./response');

var	URL_PARTS = [
	'protocol',
	'auth',
	'host',
	'port',
	'hostname',
	'search',
	'query',
	'pathname',
	'path'
];
	
var ACCEPTS = {
	'accepts'          : 'types',
	'acceptsEncodings' : 'encodings',
	'acceptsCharsets'  : 'charsets',
	'acceptsLanguages' : 'languages'
};

// Request constructor.
var	Request = util.inherit(Message, {
	/**
	 * Constructor.
	 * @param config {Object}
	 */
	constructor: function (config) {
		Message.apply(this, arguments);

		this.__.method = config.method || 'GET';
		this.__.ip = config.ip || '0.0.0.0';

		this.url(config.url || '/');
	},
	
	/**
	 * Get the cookie entries.
	 * @param [key] {string}
	 * @return {string|Object}
	 */
	cookie: function (key) {
		var __ = this.__,
			cookies = __.cookies,
			raw = this.head('cookie');
		
		if (!cookies || cookies[0] !== raw) { // Stale.
			cookies = __.cookies = [ raw, cookie.parse(raw) ];
		}
		
		return key ? (cookies[1][key] || '') : cookies[1];
	},
	
	/**
	 * Get the form entries.
	 * @param [key] {string}
	 * @return {string|Buffer|Object}
	 */
	form: function (key) {
		var __ = this.__,
			form = __.form,
			raw = this.data();
		
		if (!form || form[0] !== raw) { // Stale.
			form = __.form = [ raw,
				parse.form(raw, this.head('content-type'), this.charset() ) ];
		}
		
		return key ? (form[1][key] || '') : form[1];
	},

	/**
	 * Get/Set the request method.
	 * @param [value] {string}
	 * @return {string|Object}
	 */
	method: function (value) {
		if (value) { // Setter.
			this.__.method = Object(value).toString().toUpperCase();
			return this;
		} else { // Getter.
			return this.__.method;
		}
	},

	/**
	 * Get/Set the remote address.
	 * @param [value] {string}
	 * @return {string|Object}
	 */
	ip: function (value) {
		if (value) { // Setter.
			this.__.ip = value;
			return this;
		} else { // Getter.
			return this.__.ip;
		}
	},

	/**
	 * Get/Set the request URL.
	 * @param [value] {string}
	 * @return {string|Object}
	 */
	url: function (value) {
		var current = this.__.url || {};

		if (value) { // Setter.
			// Parse the full or partial URL.
			value = parse.url(value);

			var protocol = value.protocol || current.protocol || '',
				auth = value.auth || current.auth,
				hostname = value.hostname || current.hostname || '',
				port = value.port || current.port,
				host = (auth ? auth + '@' : '')
					+ hostname
					+ (port ? ':' + port : ''),
				pathname = value.pathname || current.pathname || '/',
				search = value.search || current.search || '';

			// Assemble a full URL.
			value = protocol
				+ (host ? '//' + host : '')
				+ pathname
				+ (search === '?' ? '' : search);

			// Parse the full URL.
			this.__.url = parse.url(value);

			return this;
		} else { // Getter.
			return current.href || '';
		}
	}
});

// Define the URL properties Getter.
URL_PARTS.forEach(function (key) {
	Object.defineProperty(Request.prototype, key, {
		get: function () {
			return this.__.url[key];
		}
	});
});

// Define the accepts-series function.
util.each(ACCEPTS, function (value, key) {
	Object.defineProperty(Request.prototype, key, {
		value: function () {
			var __ = this.__,
				accept = __.accept;
				
			if (!accept) { // Lazy initiation.
				accept = __.accept = accepts(__);
			}
		
			return accept[value].apply(accept, arguments);
		}
	});
});

module.exports = Request;
